<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point Distance Calculator</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUG9pbnQgRGlzdGFuY2UgQ2FsY3VsYXRvciIsInNob3J0X25hbWUiOiJEaXN0YW5jZSBDYWxjIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxZTE5MjYiLCJ0aGVtZV9jb2xvciI6IiMzYjgyZjYiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M00zUnZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQXlORGdnTWpRNElpQjNhV1IwYUQwaU1qUTRJaUJvWldsbmFIUTlJakkwT0NJK1BISmxZM1FnZUQwaU1qUWlJSGs5SWpJMElpQjNhV1IwYUQwaU1qQXdJaUJvWldsbmFIUTlJakl3TUNJZ2NuZzlJakV5SWlCbWFXeHNQU0lqTXpJNE1tWTJJaTgrUEhCaGRHZ2daRDBpVFRrMklqUTJMRGMxV0RBc01UQXdURGMxTERjMVdEQXNNVEF3ZEdNd0xDNDFMUzQxTERGY0xTNDFMVEZzTFRjMUxEY3lMMjQzTVMwM01pNDFZeTQxTFRBdU5UQXVOUzB4VERrc0xUUTJXaUlnWm1sc2JEMGlJell6TmpNMlpqTWlMejQ4TDNOMlp6ND0iLCJzaXplcyI6IjI0OHgyNDgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            position: relative;
        }

        .settings-icon {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(102, 126, 234, 0.1);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            color: #667eea;
        }

        .settings-icon:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: rotate(45deg);
        }

        .upload-section {
            margin-bottom: 40px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #4c51bf;
        }

        .upload-area.dragover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #4c51bf;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #667eea;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .points-section {
            margin-bottom: 30px;
        }

        .point-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .selector-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .result-section {
            background: linear-gradient(45deg, #f0f9ff, #e0f2fe);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border-left: 5px solid #667eea;
        }

        .result-text {
            font-size: 18px;
            line-height: 1.6;
            color: #2d3748;
            white-space: pre-line;
        }

        .file-info {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            color: #4c51bf;
        }

        .hidden {
            display: none;
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .settings-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .settings-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .setting-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .precision-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .precision-option {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .precision-option.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .precision-option:hover {
            border-color: #667eea;
        }

        .auto-badge {
            background: #10b981;
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .point-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìç Point Distance Calculator
            <button class="settings-icon" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
        </h1>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <p>Drag and drop your CSV/Excel file here</p>
                <p style="margin: 15px 0 10px 0; color: #666;">or</p>
                <button class="btn" id="browseBtn" type="button">Browse Files</button>
                <p style="margin-top: 15px; color: #666; font-size: 14px;">Supported formats: CSV, XLS, XLSX</p>
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xls,.xlsx" />
            </div>
            <div id="fileInfo" class="file-info hidden"></div>
        </div>

        <div id="pointsSection" class="points-section hidden">
            <div class="point-selector">
                <div class="selector-group">
                    <label for="point1Select">First Point:</label>
                    <select id="point1Select">
                        <option value="">Select first point</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label for="point2Select">Second Point:</label>
                    <select id="point2Select">
                        <option value="">Select second point</option>
                    </select>
                </div>
            </div>
            <button class="btn" id="calculateBtn" disabled>Calculate Distance</button>
        </div>

        <div id="resultSection" class="result-section hidden">
            <div id="resultText" class="result-text"></div>
        </div>

        <div id="errorSection" class="error hidden"></div>
        <div id="loadingSection" class="loading hidden">
            <div class="spinner"></div>
            Processing file...
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="settings-modal hidden">
            <div class="settings-content">
                <div class="settings-header">
                    <h2 class="settings-title">Settings</h2>
                    <button class="close-btn" id="closeSettings">√ó</button>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">Distance Precision</label>
                    <div class="setting-description">Choose how many decimal places to show in distance calculations</div>
                    <div class="precision-options">
                        <div class="precision-option" data-precision="auto">
                            Auto <span class="auto-badge">SMART</span>
                        </div>
                        <div class="precision-option" data-precision="2">2 Places</div>
                        <div class="precision-option" data-precision="3">3 Places</div>
                        <div class="precision-option" data-precision="4">4 Places</div>
                        <div class="precision-option" data-precision="6">6 Places</div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">Current Auto-Detected Precision</label>
                    <div class="setting-description" id="detectedPrecision">Will be shown after loading data</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        let pointsData = [];
        let userSettings = {
            precisionMode: 'auto',
            fixedPrecision: 4,
            detectedPrecision: 4
        };
        
        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const fileInfo = document.getElementById('fileInfo');
        const pointsSection = document.getElementById('pointsSection');
        const point1Select = document.getElementById('point1Select');
        const point2Select = document.getElementById('point2Select');
        const calculateBtn = document.getElementById('calculateBtn');
        const resultSection = document.getElementById('resultSection');
        const resultText = document.getElementById('resultText');
        const errorSection = document.getElementById('errorSection');
        const loadingSection = document.getElementById('loadingSection');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const detectedPrecision = document.getElementById('detectedPrecision');
        const pointsSection = document.getElementById('pointsSection');
        const point1Select = document.getElementById('point1Select');
        const point2Select = document.getElementById('point2Select');
        const calculateBtn = document.getElementById('calculateBtn');
        const resultSection = document.getElementById('resultSection');
        const resultText = document.getElementById('resultText');
        const errorSection = document.getElementById('errorSection');
        const loadingSection = document.getElementById('loadingSection');

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZnVuY3Rpb24oZSkgeyBjb25zb2xlLmxvZygnU1cgSW5zdGFsbGVkJyk7IH0pOyBzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZnVuY3Rpb24oZSkgeyBjb25zb2xlLmxvZygnU1cgRmV0Y2gnKTsgfSk7')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }

        // File upload handlers
        uploadArea.addEventListener('click', (e) => {
            // Only trigger file input if not clicking the browse button
            if (e.target !== browseBtn) {
                fileInput.click();
            }
        });
        browseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        // Settings handlers
        settingsBtn.addEventListener('click', openSettings);
        closeSettings.addEventListener('click', closeSettingsModal);
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) closeSettingsModal();
        });
        
        // Close settings with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !settingsModal.classList.contains('hidden')) {
                closeSettingsModal();
            }
        });

        // Initialize precision options
        document.querySelectorAll('.precision-option').forEach(option => {
            option.addEventListener('click', () => {
                const precision = option.dataset.precision;
                selectPrecision(precision);
            });
        });

        // Set default precision
        selectPrecision('auto');

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function showError(message) {
            errorSection.textContent = message;
            errorSection.classList.remove('hidden');
            setTimeout(() => errorSection.classList.add('hidden'), 5000);
        }

        function openSettings() {
            settingsModal.classList.remove('hidden');
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        function closeSettingsModal() {
            settingsModal.classList.add('hidden');
            // Restore body scroll
            document.body.style.overflow = 'auto';
        }

        function selectPrecision(precision) {
            userSettings.precisionMode = precision;
            if (precision !== 'auto') {
                userSettings.fixedPrecision = parseInt(precision);
            }
            
            // Update UI
            document.querySelectorAll('.precision-option').forEach(option => {
                option.classList.toggle('active', option.dataset.precision === precision);
            });
        }

        function getDecimalPlaces(num) {
            const str = num.toString();
            if (!str.includes('.')) return 0;
            return str.split('.')[1].length;
        }

        function detectPrecisionFromData(data) {
            let maxPrecision = 0;
            data.forEach(point => {
                maxPrecision = Math.max(
                    maxPrecision,
                    getDecimalPlaces(point.x),
                    getDecimalPlaces(point.y),
                    getDecimalPlaces(point.z)
                );
            });
            return Math.max(2, maxPrecision); // Minimum 2 decimal places
        }

        function detectPrecisionFromPoints(point1, point2) {
            return Math.max(
                getDecimalPlaces(point1.x),
                getDecimalPlaces(point1.y),
                getDecimalPlaces(point1.z),
                getDecimalPlaces(point2.x),
                getDecimalPlaces(point2.y),
                getDecimalPlaces(point2.z),
                2 // Minimum 2 decimal places
            );
        }

        function getCurrentPrecision(point1 = null, point2 = null) {
            if (userSettings.precisionMode === 'auto') {
                if (point1 && point2) {
                    return detectPrecisionFromPoints(point1, point2);
                }
                return userSettings.detectedPrecision;
            }
            return userSettings.fixedPrecision;
        }

        function showLoading() {
            loadingSection.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSection.classList.add('hidden');
        }

        function processFile(file) {
            showLoading();
            errorSection.classList.add('hidden');
            
            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();
            
            if (!['csv', 'xls', 'xlsx'].includes(fileExtension)) {
                hideLoading();
                showError('Please select a valid CSV or Excel file.');
                return;
            }

            if (fileExtension === 'csv') {
                processCSV(file);
            } else {
                processExcel(file);
            }
        }

        function processCSV(file) {
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    hideLoading();
                    parseData(results.data, file.name);
                },
                error: function(error) {
                    hideLoading();
                    showError('Error parsing CSV file: ' + error.message);
                }
            });
        }

        function processExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    hideLoading();
                    parseData(jsonData, file.name);
                } catch (error) {
                    hideLoading();
                    showError('Error parsing Excel file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseData(data, fileName) {
            try {
                pointsData = [];
                
                // Skip header row if it exists and process data
                const startRow = data.length > 0 && isNaN(parseFloat(data[0][1])) ? 1 : 0;
                
                for (let i = startRow; i < data.length; i++) {
                    const row = data[i];
                    if (row.length >= 3) {
                        const pointName = row[0] ? row[0].toString() : `Point ${i + 1}`;
                        const x = parseFloat(row[1]);
                        const y = parseFloat(row[2]);
                        const z = row[3] ? parseFloat(row[3]) : 0;
                        
                        if (!isNaN(x) && !isNaN(y)) {
                            pointsData.push({ name: pointName, x, y, z });
                        }
                    }
                }
                
                if (pointsData.length === 0) {
                    showError('No valid points found in the file. Please check the format.');
                    return;
                }
                
                // Detect precision from all data
                userSettings.detectedPrecision = detectPrecisionFromData(pointsData);
                
                // Update UI
                fileInfo.innerHTML = `
                    <strong>File loaded:</strong> ${fileName}<br>
                    <strong>Points found:</strong> ${pointsData.length}<br>
                    <strong>Detected precision:</strong> ${userSettings.detectedPrecision} decimal places
                `;
                fileInfo.classList.remove('hidden');
                
                // Update settings display
                detectedPrecision.textContent = `${userSettings.detectedPrecision} decimal places (based on your data)`;
                
                populatePointSelectors();
                pointsSection.classList.remove('hidden');
                
            } catch (error) {
                showError('Error processing file data: ' + error.message);
            }
        }

        function populatePointSelectors() {
            // Clear existing options
            point1Select.innerHTML = '<option value="">Select first point</option>';
            point2Select.innerHTML = '<option value="">Select second point</option>';
            
            // Add points to selectors
            pointsData.forEach((point, index) => {
                const option1 = document.createElement('option');
                option1.value = index;
                option1.textContent = point.name;
                point1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = index;
                option2.textContent = point.name;
                point2Select.appendChild(option2);
            });
        }

        // Point selection handlers
        point1Select.addEventListener('change', checkSelections);
        point2Select.addEventListener('change', checkSelections);

        function checkSelections() {
            const point1Index = point1Select.value;
            const point2Index = point2Select.value;
            
            calculateBtn.disabled = !point1Index || !point2Index || point1Index === point2Index;
        }

        // Calculate distance
        calculateBtn.addEventListener('click', calculateDistance);

        function calculateDistance() {
            const point1Index = parseInt(point1Select.value);
            const point2Index = parseInt(point2Select.value);
            
            if (isNaN(point1Index) || isNaN(point2Index) || point1Index === point2Index) {
                showError('Please select two different points.');
                return;
            }
            
            const point1 = pointsData[point1Index];
            const point2 = pointsData[point2Index];
            
            // Calculate 2D distance (ignoring Z coordinate as specified)
            const dx = point2.x - point1.x;
            const dy = point2.y - point1.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // Get appropriate precision
            const precision = getCurrentPrecision(point1, point2);
            
            // Format the result message
            const resultMessage = `Distance between Point (${point1.name}) and Point (${point2.name}) is "${distance.toFixed(precision)}".

The coordinates of Point (${point1.name}) is: X=${point1.x}, Y=${point1.y}, Z=${point1.z}
The coordinates of Point (${point2.name}) is: X=${point2.x}, Y=${point2.y}, Z=${point2.z}

Precision used: ${precision} decimal places ${userSettings.precisionMode === 'auto' ? '(auto-detected)' : '(manual)'}`;
            
            resultText.textContent = resultMessage;
            resultSection.classList.remove('hidden');
            
            // Scroll to result
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>